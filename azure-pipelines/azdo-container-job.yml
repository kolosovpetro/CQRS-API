trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

jobs:
  - job: PublishApp
    steps:
      - checkout: self

      - script: docker build -t my-dotnet-publish-container -f ContainerJob.Dockerfile .
        displayName: 'Build Docker Container'

      - script: docker volume create my-publish-volume
        displayName: 'Create Docker Volume'

      - script: docker run --name my-temp-container -v my-publish-volume:/app/publish my-dotnet-publish-container
        displayName: 'Run Docker Container'

      - script: docker exec my-temp-container zip -r /app/publish/MoviesAPI.zip /app/publish
        displayName: 'Zip Published Files'

      - script: docker cp my-temp-container:/app/publish/MoviesAPI.zip $(Build.ArtifactStagingDirectory)/drop/Release
        displayName: 'Copy Zip Archive to Artifact Staging Directory'

      - script: docker rm my-temp-container
        displayName: 'Remove Temporary Container'

      - task: PublishBuildArtifacts@1
        inputs:
          artifactName: 'drop'
          pathToPublish: $(Build.ArtifactStagingDirectory)/drop
